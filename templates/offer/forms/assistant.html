{% extends 'base.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/form.css' %}">
<style>
  input[type="checkbox"]#key_144:checked {
    background-color: #d64a42;
    border-color: #d64a42;
  }
  select[name="key_201"] {
    pointer-events: none;
    background-color: #e9ecef;
    color: #6c757d;
  }



.product-form-header {display:flex;align-items:center;gap:1.1rem;margin-bottom:1.5rem;margin-top:0.8rem;margin-left:0.1rem;}
.product-form-header .icon-circle {background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;height:48px;width:48px;box-shadow:0 2px 10px rgba(48,87,199,.08);}
.select2-container--default .select2-selection--single{background-color:#fff;border:1px solid #ced4da;border-radius:0.375rem;height:38px;padding:0.375rem 0.75rem;display:flex;align-items:center;font-size:1rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;}
.select2-container--default .select2-selection--single .select2-selection__rendered{color:#495057;line-height:24px;padding-left:0;padding-right:0;}
.select2-container--default .select2-selection--single .select2-selection__arrow{height:38px;right:10px;top:1px;}
.select2-container--default .select2-selection--single:focus{border-color:#86b7fe;outline:0;box-shadow:0 0 0 0.25rem rgba(13,110,253,.25);}
.select2-container--default .select2-selection--single .select2-selection__placeholder{color:#6c757d;}

</style>

<div class="container mt-3">
  <!-- Form ÃœrÃ¼n BaÅŸlÄ±ÄŸÄ± -->
  <div class="product-form-header align-items-center mb-3" style="gap:1.1rem; margin-top: 0.8rem; margin-left: 0.1rem;">
    <span class="icon-circle shadow-sm bg-white d-flex align-items-center justify-content-center" style="height:48px;width:48px;border-radius:50%;">
      <img src="{% static 'img/truck.png' %}" alt="FerdiKaza" style="width:28px;height:28px;">
    </span>
    <span class="fw-bold" style="font-size:1.20rem; color:#3057c7;">
      Ferdi Kaza
    </span>
  </div>
  <div class="row g-4">

    <!-- 1. Kutu: SigortalÄ± ve Sigorta Ettiren Kutusu -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-2">
          <div class="d-flex align-items-center">
            <div class="icon-circle p-2 rounded-circle me-2" style="background-color: rgba(214, 74, 66, 0.1);">
              <img src="{% static 'img/user_detail.png' %}" alt="User Icon" class="img-fluid" style="width: 20px; height: 18px;">
            </div>
            <h6 class="mb-0 fw-semibold" style="color: #d64a42; font-size: 0.9rem;">SigortalÄ± Bilgileri</h6>
          </div>
        </div>
        <div class="card-body p-3">
          <form id="sigortaliForm">
            {% for key in blocks.sigortali %}
              {% if key.id == 33 %}
                <!-- Toggle Switch: Sigorta Ettiren AlanÄ± AÃ§/Kapat -->
                <div class="form-check form-switch mb-2">
                <input type="checkbox"
                       class="form-check-input sigorta-ettiren-toggle"
                       name="key_{{ key.id }}"
                       id="key_{{ key.id }}"
                       {% if selected_ettiren %}checked{% endif %}>
                  <label class="form-check-label small" for="key_{{ key.id }}">{{ key.description }}</label>
                </div>
              {% else %}
                <!-- DiÄŸer readonly alanlar -->
                <div class="mb-2">
                  <label class="form-label small">{{ key.description }}</label>
                  <input type="{% if key.input_type == 'date' %}date{% else %}text{% endif %}"
                         class="form-control"
                         name="key_{{ key.id }}"
                         value="{% if key.name == 'SigortaliDogumTarihi' and customer.birth_date %}{{ customer.birth_date|date:'Y-m-d' }}{% elif key.name == 'SigortaliAdi' %}{{ customer.full_name }}{% elif key.name == 'SigortaliKimlikNo' %}{{ customer.identity_number }}{% elif key.name == 'SigortaliCepTelefonu' %}{{ primary_phone|default:'' }}{% endif %}"
                         readonly style="background-color: #e9ecef;">
                </div>
              {% endif %}
            {% endfor %}

            <!-- Sigorta Ettiren AlanÄ± (toggle ile aÃ§Ä±lÄ±r) -->
           <div id="sigortaEttirenFields" class="mt-3 pt-2 border-top {% if not selected_ettiren %}d-none{% endif %}">
            {% for key in blocks.sigorta_ettiren %}
              <div class="mb-2">
                <label class="form-label small">{{ key.description }}</label>

           {% if key.name == 'SigortaEttirenAdi' %}
              <input type="text"
                       class="form-control"
                       name="key_{{ key.id }}"
                       id="key_{{ key.id }}"
                       value="{% if selected_ettiren %}{{ selected_ettiren.full_name }}{% endif %}"
                       readonly style="background-color: #e9ecef;">

                {% elif key.name == 'SigortaEttirenKimlikNo' %}
                  <input type="text"
                         class="form-control"
                         name="key_{{ key.id }}"
                         value="{% if selected_ettiren %}{{ selected_ettiren.identity_number }}{% endif %}"
                         {% if selected_ettiren %}readonly style="background-color: #e9ecef;"{% endif %}>


                {% elif key.name == 'SigortaEttirenDogumTarihi' %}
                  <div class="mb-2">
                    <input type="text"
                           class="form-control"
                           name="key_{{ key.id }}"
                           id="sigortaEttirenDogumTarihi"
                           value="{% if selected_ettiren %}{{ selected_ettiren.birth_date }}{% endif %}"
                           {% if selected_ettiren %}readonly style="background-color: #e9ecef;"{% endif %}>
                  </div>
                {% elif key.name == 'SigortaEttirenCepTelefonu' %}
                  <input type="text"
                         class="form-control"
                         name="key_{{ key.id }}"
                         value="{% if selected_ettiren %}{{ selected_ettiren.phone_number }}{% endif %}"
                         {% if selected_ettiren %}readonly style="background-color: #e9ecef;"{% endif %}>

                {% else %}
                  <!-- VarsayÄ±lan input (ekstra alanlar varsa) -->
                  <input type="{{ key.input_type }}"
                         class="form-control"
                         name="key_{{ key.id }}"
                         {% if selected_ettiren %}readonly style="background-color: #e9ecef;"{% endif %}>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          </form>
        </div>
      </div>
    </div>

<!-- 2. Kutu: AraÃ§ Bilgileri -->
<div class="col-md-3">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-2">
      <div class="d-flex align-items-center">
        <div class="icon-circle bg-primary bg-opacity-10 p-2 rounded-circle me-2">
          <img src="{% static 'img/truck.png' %}" alt="AraÃ§ Bilgisi" class="img-fluid" style="width: 20px; height: 18px;">
        </div>
        <h6 class="mb-0 fw-semibold text-primary" style="font-size: 0.9rem;">AraÃ§ Bilgileri</h6>
      </div>
    </div>
    <div class="card-body p-3">
      {% for key in blocks.arac_bilgi %}
        {% if key.id == 156 %}
          <!-- SÄ±fÄ±r AraÃ§? Switch -->
          <div class="form-check form-switch mb-3">
            <input type="checkbox" class="form-check-input" name="key_156" id="key_156" value="1">
            <label class="form-check-label small" for="key_156">SÄ±fÄ±r AraÃ§?</label>
          </div>
        {% elif key.id == 79 %}
          <div class="mb-2">
            <label class="form-label small">{{ key.description }}</label>
            <div class="position-relative">
              <input type="{{ key.input_type|default:'text' }}"
                     class="form-control pe-5"
                     name="key_79"
                     id="key_79_input"
                     placeholder="{{ key.description }}">
              <button type="button"
                      id="sorgulaKey79Btn"
                      class="btn btn-sm fw-bold position-absolute end-0 top-0 mt-1 me-1"
                      style="background-color: #e1b45f; color: white;">
                <i class="bi bi-search"></i> Sorgula
              </button>
            </div>
          </div>
        {% elif key.id == 85 %}
          <!-- AraÃ§ TarzÄ± -->
          <div class="mb-2">
            <label class="form-label small">{{ key.description }}</label>
            <select class="form-select" name="key_85" id="key_85" required>
              <option value="">SeÃ§iniz</option>
              <!-- JS ile doldurulacak -->
            </select>
          </div>
        {% elif key.id == 81 %}
          <!-- Marka -->
          <div class="mb-2">
            <label class="form-label small">{{ key.description }}</label>
            <select class="form-select" name="key_81" id="key_81" required>
              <option value="">SeÃ§iniz</option>
              <!-- JS ile doldurulacak -->
            </select>
          </div>
        {% elif key.id == 88 %}
          <!-- Model YÄ±lÄ± -->
          <div class="mb-2">
            <label class="form-label small">{{ key.description }}</label>
            <select class="form-select" name="key_88" id="key_88" required>
              <option value="">SeÃ§iniz</option>
              <!-- JS ile doldurulacak -->
            </select>
          </div>
{% elif key.id == 82 %}
  <!-- AraÃ§ Modeli -->
  <div class="mb-2">
    <label class="form-label small">{{ key.description }}</label>
    <select class="form-select" name="key_82" id="key_82" required>
      <option value="">SeÃ§iniz</option>
      <!-- JS ile doldurulacak -->
    </select>
  </div>

      {% elif key.id == 80 %}
        <!-- 80 no'lu Alan â€“ Marka Tip Kodu -->
        <div class="mb-2">
          <label class="form-label small">{{ key.description }}</label>
          <input type="text"
                 class="form-control"
                 name="key_80"
                 id="key_80"
                 readonly>          <!-- kullanÄ±cÄ± deÄŸiÅŸtiremesin -->
        </div>

      {% else %}
        <div class="mb-2">
          <label class="form-label small">{{ key.description }}</label>
          <input type="{{ key.input_type|default:'text' }}"
                 class="form-control"
                 name="key_{{ key.id }}">
        </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
</div>




    <!-- 3. Kutu: Ek Bilgiler (BoÅŸ kutu, iÃ§eriÄŸi sonra doldurulacak) -->
<div class="col-md-3">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-2">
      <div class="d-flex align-items-center">
        <div class="icon-circle bg-info bg-opacity-10 p-2 rounded-circle me-2">
          <img src="{% static 'img/list_detail.png' %}" alt="Ek Bilgi Icon" class="img-fluid" style="width: 18px; height: 16px;">
        </div>
        <h6 class="mb-0 fw-semibold text-info" style="font-size: 0.9rem;">Ek Bilgiler</h6>
      </div>
    </div>
    <div class="card-body p-3">

      {% for key in blocks.ek_bilgiler %}
        <div class="mb-2">
          <label class="form-label small">{{ key.description }}</label>
          <div id="key_{{ key.id }}_container">
            <input type="{{ key.input_type|default:'text' }}" class="form-control" name="key_{{ key.id }}" id="key_input_{{ key.id }}">
          </div>
        </div>
      {% endfor %}

    </div>
  </div>
</div>



    <!-- 4. Kutu: Teklif Bilgileri (Zaten hazÄ±r) -->
    <div class="col-md-3">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-2">
          <div class="d-flex align-items-center">
            <div class="icon-circle bg-warning bg-opacity-10 p-2 rounded-circle me-2">
              <img src="{% static 'img/list_detail.png' %}" alt="Teklif Icon" class="img-fluid" style="width: 18px; height: 16px;">
            </div>
            <h6 class="mb-0 fw-semibold text-warning" style="font-size: 0.9rem;">Teklif Bilgileri</h6>
          </div>
        </div>
        <div class="card-body p-3">
          {% for key in blocks.teklif %}
            {% with input_id="teklif_key_"|add:key.id|stringformat:"s" %}
            <div class="mb-2">
              <label class="form-label small" for="{{ input_id }}">{{ key.description }}</label>
              {% if key.input_type == "select" or key.parameters|length > 0 %}
                <select name="key_{{ key.id }}" id="{{ input_id }}" class="form-select">
                  <option value="">SeÃ§iniz</option>
                  {% for param in key.parameters %}
                    <option value="{{ param.ParameterID }}">{{ param.ParameterName }}</option>
                  {% endfor %}
                </select>
              {% else %}
                <input type="{{ key.input_type|default:'text' }}"
                       class="form-control"
                       name="key_{{ key.id }}"
                       id="{{ input_id }}"
                       {% if key.readonly %}readonly style="background-color: #e9ecef;"{% endif %}>
              {% endif %}
            </div>
            {% endwith %}
          {% endfor %}
          <div class="mb-2 text-muted small mt-3">
            <strong>Proposal ID:</strong> {{ proposal_id }}<br>
            <strong>ÃœrÃ¼n Kodu:</strong> {{ product_code }}
          </div>
          <div class="d-grid">
            <button id="submitOffer" type="button" class="btn btn-primary btn-sm">Teklif Al</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<input type="hidden" name="key_204" id="key_204">
<input type="hidden" name="key_205" id="key_205">
<input type="hidden" name="key_207" id="key_207">
<input type="hidden" name="key_206" id="key_206">
<input type="hidden" name="key_208" id="key_208">
<input type="hidden" name="key_209" id="key_209">
<input type="hidden" name="key_210" id="key_210">
<input type="hidden" name="key_212" id="key_212">
<input type="hidden" name="key_211" id="key_211">
<input type="hidden" name="key_213" id="key_213">

<script src="{% static 'js/utils_customer.js' %}"></script>

<script>
  window.proposal_id = "{{ proposal_id }}";
  window.product_code = "{{ product_code }}";
  window.agency_id = "{{ request.user.agency.id }}";
  window.user_id = "{{ request.user.id }}";
  window.formType = "{{ form_type }}";
  window.branch_id = "{{ request.user.branch.id }}";
  window.customer_id = "{{ customer.id }}";    // <<< EKLE (customer objesi sayfada varsa!)
</script>



<script>

document.addEventListener("DOMContentLoaded", function() {
  const sifirAracCheckbox = document.getElementById("key_156");
  const key79Input = document.getElementById("key_79_input");
  const sorgulaBtn = document.getElementById("sorgulaKey79Btn");

  function updateKey79State() {
    if (sifirAracCheckbox && key79Input && sorgulaBtn) {
      if (sifirAracCheckbox.checked) {
        key79Input.readOnly = true;
        key79Input.style.backgroundColor = "#e9ecef";
        sorgulaBtn.disabled = true;                    // ðŸ”’ Buton pasif
        sorgulaBtn.classList.add("disabled");
      } else {
        key79Input.readOnly = false;
        key79Input.style.backgroundColor = "";
        sorgulaBtn.disabled = false;                   // ðŸ”“ Buton aktif
        sorgulaBtn.classList.remove("disabled");
      }
    }
  }

  if (sifirAracCheckbox && key79Input && sorgulaBtn) {
    sifirAracCheckbox.addEventListener("change", updateKey79State);
    updateKey79State(); // Sayfa ilk yÃ¼klendiÄŸinde de uygula
  }
});

/* ---------- yardÄ±mcÄ± ---------- */
function getCookie(n){const m=document.cookie.match(new RegExp("(?:^|; )"+n+"=([^;]*)"));return m?decodeURIComponent(m[1]):null;}
function clearSelect(sel,ph="SeÃ§iniz"){
  sel.innerHTML=`<option value="">${ph}</option>`;
  if($(sel).hasClass("select2-hidden-accessible")) $(sel).val(null).trigger("change.select2");
}

/* ---------- global ---------- */
let abortYear=null;

/* ---------- aÃ§Ä±lÄ±ÅŸ ---------- */
document.addEventListener("DOMContentLoaded",()=>{ loadTarzMarka(); });

/* ---------- listeleri doldur ---------- */
async function loadTarzMarka(){
  const tSel=document.getElementById("key_85"),
        mSel=document.getElementById("key_81");

  const [tarz,marka]=await Promise.all([
    fetch("/gateway/get-arac-tarzlari/").then(r=>r.json()),
    fetch("/gateway/get-arac-markalari/").then(r=>r.json())
  ]);

  clearSelect(tSel,"KullanÄ±m TarzÄ±"); clearSelect(mSel,"Marka");

  tarz.success  && tarz.tarzlar.forEach(t=>tSel.insertAdjacentHTML("beforeend",`<option value="${t.code}">${t.name}</option>`));
  marka.success && marka.brands.forEach(b=>mSel.insertAdjacentHTML("beforeend",`<option value="${b.code}">${b.name}</option>`));

  $('#key_85,#key_81,#key_88,#key_82').select2({width:"100%",placeholder:"SeÃ§iniz",allowClear:true});

  $('#key_85,#key_81').on('select2:select',()=>{
      const t=$('#key_85').val(), m=$('#key_81').val();
      if(t&&m) loadModelYears(t,m);
  });
}

/* ---------- model year servisi ---------- */
async function loadModelYears(tarz,marka){
  const ySel=document.getElementById("key_88"),
        modSel=document.getElementById("key_82");
  clearSelect(ySel,"Model YÄ±lÄ±"); clearSelect(modSel,"AraÃ§ Modeli");

  if(abortYear) abortYear.abort();
  abortYear=new AbortController();

  const data=await fetch("/gateway/get-model-years/",{
      method:"POST",
      headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")},
      body:JSON.stringify({tarz_kodu:tarz,marka_kodu:marka}),
      signal:abortYear.signal
    }).then(r=>r.json()).catch(e=>{if(e.name!=="AbortError")console.error(e);return{success:false};});

  if(!data.success) return;

  if($(ySel).hasClass("select2-hidden-accessible")) $(ySel).select2('destroy');
  data.years.forEach(y=>ySel.insertAdjacentHTML("beforeend",`<option value="${y.code}">${y.name}</option>`));
  $(ySel).select2({width:"100%",placeholder:"Model YÄ±lÄ±",allowClear:true})
        .off('select2:select').on('select2:select',e=>{
            loadModelList(tarz,marka,e.params.data.id);
        });
}

/* ---------- abort kontrolÃ¼ ---------- */
let tipAborter = null;   // globalde bir kez tanÄ±mlÄ± olsun

/* ---------- model list servisi ---------- */
async function loadModelList(tarz, marka, yil){
  const modSel = document.getElementById("key_82");     // model select
  const key80  = document.getElementById("key_80");      // gÃ¶rÃ¼nÃ¼r 80
  clearSelect(modSel, "AraÃ§ Modeli"); if (key80) key80.value = "";

  /* â€” Ã¶nceki Ã§aÄŸrÄ± varsa iptal et â€” */
  if (tipAborter) tipAborter.abort();
  tipAborter = new AbortController();

  const data = await fetch("/gateway/get-arac-modelleri/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ tarz_kodu: tarz, marka_kodu: marka, yil_kodu: yil }),
      signal: tipAborter.signal
    }).then(r => r.json())
      .catch(e => { if (e.name !== "AbortError") console.error(e); return { success:false }; });

  if (!data.success) return;

  /* â€” Select2'yi bir kez destroy et, sonra listeyi ekle â€” */
  if ($(modSel).hasClass("select2-hidden-accessible")) $(modSel).select2("destroy");

  data.models.forEach(m => {
      const [label, num=""] = (m.name || "").split("|").map(s => s.trim());
      modSel.insertAdjacentHTML(
        "beforeend",
        `<option value="${m.code}" data-num="${num}">${label}</option>`
      );
  });

  /* â€” tekrar init, ama SEÃ‡Ä°MÄ° SIFIRLAMADAN â€” */
  $(modSel).select2({ width: "100%", placeholder: "AraÃ§ Modeli", allowClear: true });

  /* â€” seÃ§ildikÃ§e 80 no'lu inputu gÃ¼ncelle â€” */
  $(modSel).off("select2:select").on("select2:select", function (e) {
      const opt = modSel.options[modSel.selectedIndex];
      if (key80) key80.value = opt ? (opt.dataset.num || "") : "";
  });
}

document.addEventListener("DOMContentLoaded", function() {
  // --- EK BÄ°LGÄ°LER (select/input otomasyonu) ---
  {% for key in blocks.ek_bilgiler %}
    fetch("/database/api/parameters-for-key/?key_id={{ key.id }}")
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          let html = '<select class="form-select" name="key_{{ key.id }}" id="key_input_{{ key.id }}">';
          html += '<option value="">SeÃ§iniz</option>';
          data.forEach(param => {
            html += `<option value="${param.id}">${param.name}</option>`;
          });
          html += '</select>';
          document.getElementById("key_{{ key.id }}_container").innerHTML = html;
        }
      });
  {% endfor %}

  // --- TEKLÄ°F AL SUBMIT BUTTON ---
  const submitBtn = document.getElementById("submitOffer");

  if (submitBtn) {
    submitBtn.addEventListener("click", async function () {
      // 1. MÃ¼ÅŸteri numaralarÄ± Ã§Ã¶zÃ¼mlensin
      if (typeof resolveCustomerNosBeforeSubmit === "function") {
        await resolveCustomerNosBeforeSubmit();
      }

      // 2. Form verilerini topla
      const data = getFullOfferFormData(true);

      // 3. Proposal oluÅŸtur (key kayÄ±tlarÄ± da dahil)
      const proposalCreateRes = await fetch("/proposal/create-proposal-entry/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          customer_id: window.customer_id,
          proposal_id: data.proposal_id,
          product_code: data.product_code,
          agency_id: window.agency_id,
          user_id: window.user_id,
          form_type: window.formType,
          branch_id: window.branch_id || null,
          form_data: data
        }),
      }).then(res => res.json());

      if (!proposalCreateRes.success) {
        console.error("âŒ Proposal kayÄ±t hatasÄ±:", proposalCreateRes.error);
        return;
      }

      // 4. UUID ile detay sayfasÄ±na yÃ¶nlen
      const uuids = proposalCreateRes.uuids || {};
      const firstUuid = uuids[data.product_code];

      if (firstUuid) {
        showGlobalModalPopup(
          "Teklif sayfasÄ±na yÃ¶nlendiriliyorsunuz, lÃ¼tfen bekleyiniz...",
          { type: "info", title: "YÃ¶nlendiriliyorsunuz", autoClose: false }
        );

        const popupModal = document.getElementById("globalPopup");
        const closeBtn = popupModal.querySelector(".btn-close");
        if (closeBtn) closeBtn.style.display = "none";

        setTimeout(() => {
          window.location.href = `/proposal/${firstUuid}/`;
        }, 500);
      }

      window.proposal_uuids = uuids;
    });
  }
});



</script>




{% endblock %}
